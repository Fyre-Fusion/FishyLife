<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FishyLife â€“ Fishing</title>
<style>
body{margin:0;font-family:Arial;background:#4db8ff;color:white;text-align:center;}
header{display:flex;justify-content:space-around;padding:10px;background:rgba(0,0,0,.35);}
header a{color:white;text-decoration:none;}
#track{width:520px;height:40px;background:#1f618d;border-radius:25px;margin:20px auto;position:relative;overflow:hidden;}
#fish{width:18px;height:18px;background:white;border-radius:50%;position:absolute;top:11px;}
#box{height:40px;border:3px solid red;position:absolute;top:0;}
.barWrap{width:520px;height:14px;background:#222;margin:6px auto;border-radius:8px;}
.bar{height:100%;width:0%;border-radius:8px;}
#catchBar{background:lime;}
button{padding:12px 18px;font-size:18px;margin:6px;}
</style>
</head>
<body>

<header>
<a href="index.html">ğŸ  Home</a>
<a href="shop.html">ğŸ›’ Shop</a>
</header>

<h1>ğŸ£ Fishing</h1>
<div>ğŸŒŠ Depth: <span id="depthText"></span></div>

<div id="track">
    <div id="fish"></div>
    <div id="box"></div>
</div>

<div class="barWrap"><div id="catchBar" class="bar"></div></div>
<div id="rarityText"></div>

<button id="left">â¬…ï¸</button>
<button id="right">â¡ï¸</button>

<script>
// ================= SAFE LOAD =================
let g = JSON.parse(localStorage.getItem("game"));
if(!g){ location.href="index.html"; }

if(g.bait <= 0){
    alert("No bait!");
    location.href="shop.html";
}

// consume bait ONCE
g.bait--;
localStorage.setItem("game",JSON.stringify(g));

// ================= DEPTH =================
const depth = Math.floor(Math.random()*100)+1;
document.getElementById("depthText").textContent = depth+"m";

// ================= BAIT =================
const baitType = g.baitType || "Basic";
const baitBoost = {
    Basic:1,
    Advanced:1.2,
    Shiny:1.6
}[baitType] || 1;

// ================= SKILLS (SAFE DEFAULTS) =================
const skills = g.skills || {control:0,power:0,glide:0};

// ================= FISH =================
const fish = {
    rarity:(1 + depth/90) * baitBoost,
    xp:Math.floor(20 + depth*1.4)
};

document.getElementById("rarityText").textContent =
fish.rarity < 1.2 ? "Common" :
fish.rarity < 1.8 ? "Rare" : "Legendary";

// ================= PHYSICS =================
const BAR = 520;

let fishX = 260;
let fishV = (Math.random()*2+1) * (Math.random()<0.5?-1:1);

let boxX = 200;
let boxV = 0;

const accel = 1.1 + skills.power*0.3;
const friction = 0.9 - skills.glide*0.02;

const boxW = 90 + skills.control*15;
document.getElementById("box").style.width = boxW+"px";

let input = 0;
let catchProg = 0;
let gameOver = false;

const bar = document.getElementById("catchBar");

// ================= INPUT =================
document.onkeydown = e=>{
    if(e.key==="ArrowLeft") input=-1;
    if(e.key==="ArrowRight") input=1;
};
document.onkeyup = ()=>input=0;

document.getElementById("left").onmousedown = ()=>input=-1;
document.getElementById("right").onmousedown = ()=>input=1;
document.getElementById("left").onmouseup =
document.getElementById("right").onmouseup = ()=>input=0;

// ================= MAIN LOOP =================
const loop = setInterval(()=>{
    if(gameOver) return;

    // Fish motion
    fishV += (Math.random()-0.5)*0.3*fish.rarity;
    fishX += fishV;
    if(fishX<0 || fishX>BAR-18) fishV*=-1;
    document.getElementById("fish").style.left = fishX+"px";

    // Box physics (velocity + inertia)
    boxV += input * accel;
    boxV *= friction;
    boxX += boxV;
    boxX = Math.max(0, Math.min(BAR-boxW, boxX));
    document.getElementById("box").style.left = boxX+"px";

    // Catch logic
    const center = fishX + 9;
    const inside = center > boxX && center < boxX + boxW;

    catchProg += inside
        ? (1 + skills.power*0.6)
        : -(0.8 + fish.rarity*0.4);

    catchProg = Math.max(0, Math.min(100, catchProg));
    bar.style.width = catchProg + "%";

    // WIN
    if(catchProg >= 100){
        gameOver = true;
        clearInterval(loop);

        g.xp += fish.xp;
        g.inventory ??= {};
        g.inventory["Fish"] = (g.inventory["Fish"] || 0) + 1;

        localStorage.setItem("game",JSON.stringify(g));

        setTimeout(()=>{
            alert(`ğŸŸ Caught fish!\nDepth: ${depth}m\n+${fish.xp} XP`);
            location.href="index.html";
        },200);
    }
},16);
</script>

</body>
</html>

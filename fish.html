<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FishyLife - Fishing</title>
<style>
body{margin:0;font-family:Arial;background:#4db8ff;color:white;text-align:center;}
header{display:flex;justify-content:space-around;padding:10px;background:rgba(0,0,0,.35);}
header a{color:white;text-decoration:none;}
#track{width:520px;height:40px;background:#1f618d;border-radius:25px;margin:30px auto;position:relative;}
#fish{width:20px;height:20px;background:white;border-radius:50%;position:absolute;top:10px;}
#box{width:120px;height:40px;border:3px solid red;position:absolute;top:0;}
.barWrap{width:520px;height:16px;background:#222;margin:6px auto;border-radius:8px;}
.bar{height:100%;width:0%;border-radius:8px;}
#catchBar{background:lime;}
#rarityBar{background:violet;}
button{padding:12px 18px;font-size:20px;margin:10px;cursor:pointer;}
#customBaitDiv{display:none;margin-top:10px;}
</style>
</head>
<body>

<header>
<a href="index.html">üè† Home</a>
<a href="shop.html">üõí Shop</a>
</header>

<h1>üé£ Fishing</h1>
<p>Keep the fish inside the red box to catch it!</p>

<div id="track">
    <div id="fish"></div>
    <div id="box"></div>
</div>

<div class="barWrap"><div id="catchBar" class="bar"></div></div>
<div class="barWrap"><div id="rarityBar" class="bar"></div></div>

<button id="left">‚¨ÖÔ∏è</button>
<button id="right">‚û°Ô∏è</button>

<div id="customBaitDiv">
<h2>Create Custom Bait</h2>
<select id="customFishSelect"></select>
<button onclick="createCustomBait()">Create Bait</button>
</div>

<script>
// ----- LOAD GAME -----
let g = JSON.parse(localStorage.getItem("game")) || null;
if(!g){
    alert("No save found! Returning to home.");
    location.href="index.html";
}
if(g.bait<=0){alert("No bait!"); location.href="shop.html"; throw new Error("No bait");}
g.bait--;
localStorage.setItem("game", JSON.stringify(g));

// Rod names
const rods=[
  {name:"Basic Rod",cost:0},
  {name:"Silver Rod",cost:200},
  {name:"Gold Rod",cost:400},
  {name:"Dark Rod",cost:600},
  {name:"Reef Rod",cost:800},
  {name:"Lava Rod",cost:1200},
  {name:"Clam Rod",cost:1600},
  {name:"Lucky Rod",cost:1800}
];

// ----- FISH DATA PER LOCATION -----
const fishByLoc={
Creek:[{name:"Minnow",xp:10,rarity:0.6},{name:"Bluegill",xp:15,rarity:0.9},{name:"Bass",xp:20,rarity:1.2},{name:"Tilapia",xp:25,rarity:1.0},{name:"Clownfish",xp:30,rarity:1.1}],
Lake:[{name:"Trout",xp:25,rarity:1.1},{name:"Catfish",xp:30,rarity:1.4},{name:"Salmon",xp:40,rarity:1.7},{name:"Peacock Bass",xp:50,rarity:1.6},{name:"Turtle",xp:35,rarity:1.0},{name:"Kepper",xp:35,rarity:1.0}],
Ocean:[{name:"Red Snapper",xp:45,rarity:1.5},{name:"Moonfish",xp:55,rarity:1.7},{name:"Tigershark",xp:150,rarity:2.2},{name:"Basa",xp:40,rarity:1.2},{name:"Goldfish",xp:20,rarity:0.9},{name:"Angelfish",xp:22,rarity:1.0},{name:"Lemonshark",xp:120,rarity:2.0},{name:"Lungfish",xp:45,rarity:1.1},{name:"Squid",xp:35,rarity:1.0},{name:"Crabs",xp:20,rarity:0.9},{name:"Crawfish",xp:15,rarity:0.8},{name:"Mussels",xp:25,rarity:1.0},{name:"Clams",xp:25,rarity:1.0},{name:"Abyssal Octopus",xp:500,rarity:3.0}]
};

// ----- PICK RANDOM FISH -----
const list = fishByLoc[g.location];
let fish = list[Math.floor(Math.random()*list.length)];

// ----- VARIABLES -----
const BAR = 520;
let fishX = 250, fishDir = Math.random()<0.5?-1:1;
let boxX = 200, move = 0;
let boxW = 100 + g.rod*10;
document.getElementById("box").style.width = boxW + "px";

let catchProg = 0;
let catchBar = document.getElementById("catchBar");
let rarityBar = document.getElementById("rarityBar");
rarityBar.style.width = (fish.rarity*35) + "%";

// ----- INPUT -----
document.onkeydown = e=>{ if(e.key==="ArrowLeft") move=-1; if(e.key==="ArrowRight") move=1; };
document.onkeyup = ()=>move=0;

document.getElementById("left").onmousedown = ()=>move=-1;
document.getElementById("right").onmousedown = ()=>move=1;
document.getElementById("left").onmouseup = document.getElementById("right").onmouseup = ()=>move=0;

// ----- MUTATION AND SPECIAL ITEMS -----
function mutateFish(f){
    let rand = Math.random();
    let rodBonus = (rods[g.rod]?.name==="Lucky Rod")?0.05:0; 
    let mutation="";
    if(rand < 0.02 + rodBonus) mutation="Rainbow";       
    else if(rand < 0.12 + rodBonus) mutation="Gold";      
    else if(rand < 0.22 + rodBonus) mutation="Silver";    
    return mutation;
}

// Chance to spawn special items instead of fish
function specialCatch(){
    let roll = Math.random();
    if(roll < 0.03) return "Chest"; // 3% chance
    if(roll < 0.06) return "Boot";  // next 3%
    return null;
}

// ----- MAIN LOOP -----
let special=null;
const loop = setInterval(()=>{
    if(!special){
        special = specialCatch();
        if(special==="Chest"){
            fishX = Math.random()*(BAR-20);
            fishDir = Math.random()<0.5?-1:1;
        }
        if(special==="Boot"){
            fishX = Math.random()*(BAR-20);
            fishDir = Math.random()<0.5?-1:1;
        }
    }

    fishX += fishDir * (2 + (fish?.rarity || 1));
    if(Math.random()<0.02) fishDir *= -1;
    if(fishX <0 || fishX>BAR-20) fishDir*=-1;
    document.getElementById("fish").style.left = fishX+"px";

    boxX += move*6;
    boxX = Math.max(0, Math.min(BAR-boxW, boxX));
    document.getElementById("box").style.left = boxX+"px";

    const center = fishX + 10;
    const inside = center > boxX && center < boxX + boxW;
    if(inside) catchProg += 0.8;
    else catchProg -= 0.6 * (fish?.rarity || 1);

    catchProg = Math.max(0, Math.min(100, catchProg));
    catchBar.style.width = catchProg+"%";

    if(catchProg>=100){
        clearInterval(loop);

        if(special==="Chest"){
            let coins = Math.floor(Math.random()*50 + 20);
            let xp = Math.floor(Math.random()*20 + 10);
            g.money += coins;
            g.xp += xp;
            alert(`ü™ô You found a Sunken Chest! +$${coins}, +${xp} XP`);
        }
        else if(special==="Boot"){
            g.bait = Math.max(0, g.bait-1);
            alert("üë¢ You caught a Boot! Lost 1 bait...");
        }
        else{
            let mutation = mutateFish(fish.name);
            let valueMultiplier=1;
            if(mutation==="Silver") valueMultiplier=1.10;
            if(mutation==="Gold") valueMultiplier=1.15;
            if(mutation==="Rainbow") valueMultiplier=10;

            let finalFishName = fish.name + (mutation? " ("+mutation+")":"");

            g.inventory[finalFishName] = (g.inventory[finalFishName]||0)+1;
            g.caught[fish.name] = true;
            g.fishCount++;
            g.xp += fish.xp;
            alert(`üêü You caught a ${finalFishName}! Value x${valueMultiplier}`);
        }

        while(g.xp>=g.xpNeed){
            g.xp -= g.xpNeed;
            g.level++;
            g.xpNeed = Math.floor(g.xpNeed*1.5);
        }
        localStorage.setItem("game", JSON.stringify(g));
        setTimeout(()=>location.href="index.html",100);
    }
},16);

// ----- CUSTOM BAIT FOR LV15+ -----
const customFish = ["Salmon","Tilapia","Clownfish","Goldfish","Kepper"];
if(g.level>=15){
    const div = document.getElementById("customBaitDiv");
    div.style.display = "block";
    const sel = document.getElementById("customFishSelect");
    sel.innerHTML = "";
    customFish.forEach(f=>{
        if(g.inventory[f] && g.inventory[f]>0){
            const opt = document.createElement("option");
            opt.value = f;
            opt.textContent = f;
            sel.appendChild(opt);
        }
    });
}

function createCustomBait(){
    const f = document.getElementById("customFishSelect").value;
    if(!f){alert("No fish selected!"); return;}
    if(g.inventory[f]<=0){alert("You don't have that fish."); return;}
    g.inventory[f]--;
    g.bait += 1;
    if(g.inventory[f]<=0) delete g.inventory[f];
    localStorage.setItem("game", JSON.stringify(g));
    alert("Custom bait created from "+f+"!");
    location.reload();
}
</script>

</body>
</html>
